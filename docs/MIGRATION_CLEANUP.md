# Database Migration Cleanup

## Overview

This document describes the process used to clean up the complex and conflicting database migration history in the Biosphere Alpha project. The migration history had become unwieldy with multiple heads, branches, and inconsistencies between the migration files and the actual database schema.

## Problem Description

The project was experiencing several issues related to database migrations:

1. Multiple migration heads and branches causing conflicts
2. Inconsistencies between migration files and actual database schema
3. DBeaver visibility issues where tables existed in the database but were not properly recognized
4. Difficulty in adding new migrations due to the complex dependency tree
5. Column naming discrepancies between what was expected in code and what existed in the database

## Solution Approach

Rather than attempting to resolve all the conflicts in the existing migration files, we took a "reset and baseline" approach:

1. Created a full database backup to preserve all data
2. Archived all existing migration files
3. Created a single comprehensive baseline migration that represents the current state of the database
4. Updated the `alembic_version` table to reference this new baseline migration
5. Restarted the backend service to ensure it recognized the new migration state

## Implementation Details

### 1. Database Backup

A full backup of the database was created before any changes were made:

```bash
docker exec biosphere_alpha-db-1 pg_dump -U postgres -d knowledgeplan_dev > backend/backup/db_backup_YYYYMMDD_HHMMSS.sql
```

### 2. Archiving Old Migrations

All previous migration files were moved to an archive directory for reference:

```bash
mkdir -p backend/app/db/migrations/archive
mv backend/app/db/migrations/versions/* backend/app/db/migrations/archive/
```

### 3. Creating Baseline Migration

A new baseline migration (`0001_baseline_schema.py`) was created that:
- Contains all current tables, indexes, and constraints
- Matches the actual database schema that was in use
- Serves as a single "head" for future migrations to build upon
- Has no dependencies on previous migrations

### 4. Updating Alembic Version

The `alembic_version` table was updated to reference the new baseline:

```sql
DELETE FROM alembic_version; 
INSERT INTO alembic_version (version_num) VALUES ('0001_baseline_schema');
```

### 5. Verification

The current migration state was verified to confirm it points to the new baseline:

```bash
alembic current
# Output: 0001_baseline_schema (head)
```

## Benefits

This cleanup provides several benefits:

1. **Simplified Migration History**: A single baseline migration makes the history clear and easy to understand
2. **Consistent Schema**: The baseline migration accurately reflects the actual database schema
3. **Improved Tool Compatibility**: DBeaver and other tools can now properly recognize the database structure
4. **Easier Future Development**: New migrations can build upon a stable and accurate baseline
5. **Maintained Data Integrity**: All existing data was preserved throughout the process

## Future Migration Guidelines

To maintain a clean migration history going forward:

1. Always create new migrations from the current head using `alembic revision --autogenerate`
2. Review autogenerated migrations carefully before committing them
3. Use meaningful names for migration files that describe their purpose
4. Document complex migrations with detailed comments
5. Test migrations both forward (upgrade) and backward (downgrade)
6. Avoid direct manipulation of the database schema outside of migrations
7. Periodically check for discrepancies between migrations and actual schema

## Conclusion

The migration cleanup was successful, resulting in a single clean baseline that accurately represents the current database schema while preserving all existing data. This provides a solid foundation for future database schema changes.